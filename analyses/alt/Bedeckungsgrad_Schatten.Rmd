---
title: "Bedeckungsgrad_Schatten"
author: "Samantha Rubo"
date: "23 7 2020"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, error=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

![Spinat-Bild](../data/F4b_Tag_15.jpeg)


```{r}
library(raster)
library(jpeg)
library(RColorBrewer)
library(ggplot2)
library(dplyr)
library(reshape2)
```

##Bild laden:
```{r}
img <- readJPEG("../data/F4b_Tag_15.jpeg")

imgDm <- dim(img)

imgRGB <- data.frame(
  x = rep(1:imgDm[2], each = imgDm[1]),
  y = rep(imgDm[1]:1, imgDm[2]),
  R = as.vector(img[,,1]),
  G = as.vector(img[,,2]),
  B = as.vector(img[,,3])
  )
```


```{r}
plot_spinach <- function(z,pal,...) {
  x2 <- 1:imgDm[2]
  y2 <- 1:imgDm[1]
  
  target_matrix <- matrix(data = z, nrow = imgDm[1], ncol = imgDm[2], byrow = FALSE) 
  n <- as.factor(target_matrix) %>% unique %>% length
  n <- ifelse(n > 255, 255,n)
  graphics::image(x=x2, y=y2,t(target_matrix)[,nrow(target_matrix):1],
                asp =1, 
                col=hcl.colors(n, palette = pal), 
                useRaster=TRUE,
                ...)
}
```

##Alle Kanäle plotten
```{r}
plot_spinach(z = img[,,1], pal = "Grays", main = "Roter Kanal")
plot_spinach(z = img[,,2], pal = "Grays", main = "Grüner Kanal")
plot_spinach(z = img[,,3], pal = "Grays", main = "Blauer Kanal")
```


```{r}
kClusters <- 5
kMeans <- kmeans(imgRGB[, c("R", "G", "B")], centers = kClusters)
cols <- brewer.pal(n = kClusters, name = "Spectral")
#cols <- brewer.pal(n = kClusters, name = "Set1")
kColours <- cols[kMeans$cluster]
kColours_numeric <- c(1:kClusters)[kMeans$cluster]
```

Plotte das Ergebnis:
```{r}
plot_spinach(z = kColours_numeric, pal = "Spectral",main="Ergebnis des Kmeans-Clusterings")

```

##Scatter der Kanäle
```{r}
head(imgRGB)
#plot(imgRGB$R, imgRGB$G)
smoothScatter(imgRGB$R, imgRGB$G)
points(0.4,0.4, pch=16)
smoothScatter(imgRGB$R, imgRGB$B)
smoothScatter(imgRGB$B, imgRGB$G)
```

#Histogram des Kanäle
```{r}
img_melted <- melt(imgRGB, measure.vars = c("R", "G", "B"))
lattice::histogram(~ value ,data= img_melted, main="Grauwert")
lattice::histogram(~ value | variable,data= img_melted)
```

#Methodik nach Hyun K. Suh et al. (2017)
Precision Agric (2018) 19:218–237

#RGB normalisieren:
```{r}
imgRGB_norm <- with(imgRGB, data.frame(R=R/(R+G+B),
                                       G=G/(R+G+B),
                                       B=B/(R+G+B) ))
smoothScatter(imgRGB$R, imgRGB_norm$R)
smoothScatter(imgRGB$G, imgRGB_norm$G)
smoothScatter(imgRGB$B, imgRGB_norm$B)

img_melted <- melt(imgRGB_norm, measure.vars = c("R", "G", "B"))
lattice::histogram(~ value | variable,data= img_melted)
```

##Alle genormten Kanäle plotten
```{r}
plot_spinach(z = imgRGB_norm$R, pal = "Grays", main = "Roter Kanal (genormt)")
plot_spinach(z = imgRGB_norm$G, pal = "Grays", main = "Grüner Kanal (genormt)")
plot_spinach(z = imgRGB_norm$B, pal = "Grays", main = "Blauer Kanal (genormt)")
```


##Step a: excess green (ExG)
```{r}
#excess green index (ExG = 2 g - r-b)
ExG <- with(data = imgRGB_norm, 2*G - R -B) 
```

Grünen Kanal und ExG plotten:
```{r}
plot_spinach(z = img[,,2], pal = "Grays",main="Grüner Kanal")
plot_spinach(z = ExG, pal = "Grays",main="ExG")
```
Histogram ExG
```{r}
t1 <- 0.2 #0.3 #threshold according to histogram
hist(ExG, breaks = 20)
abline(v=t1, col ="red")
```

##Step b+c: Otsu threshold
```{r}
ExG_Otsu <- ifelse(ExG < t1,0,1) #t1 wir oben im Histogram definiert
plot_spinach(z = ExG_Otsu, pal = "Grays",main="Otsu theshold")
```

##Step d: color space conversion (RGB to XYZ)
```{r}
xyz <- convertColor(color = imgRGB[,c("R","G","B")], from = "sRGB", to = "XYZ",
             scale.in = 1, scale.out = 1, clip = TRUE)
plot_spinach(z = xyz[,1], pal = "Grays",main="XYZ-Konversion: roter Kanal")
plot_spinach(z = xyz[,2], pal = "Grays",main="XYZ-Konversion: grüner Kanal")
plot_spinach(z = xyz[,3], pal = "Grays",main="XYZ-Konversion: blauer Kanal")
```


###XYZ normalisation:
```{r}
xyz <- as.data.frame(xyz)
xyz_norm <- with(xyz, data.frame(x=V1/(V1+V2+V3),
                                 y=V2/(V1+V2+V3),
                                 z=V3/(V1+V2+V3) ))
```



##Step e: contrast enhancement of the ground shadow region
```{r}
#Contrasted Ground Shadow (CGS)
CGS <- (xyz_norm$x * xyz_norm$y) / xyz_norm$z
#rot*grün / blau
plot_spinach(z = CGS, pal = "Grays",main="Contrasted Ground Shadow (CGS)")
```

Histogram CGS
```{r}
t1 <- 0.6 #threshold according to histogram
t2 <- 0.9
hist(CGS, breaks = 30)
abline(v=t1, col ="red")
abline(v=t2, col ="green")
```

##Step f: Otsu multi-level threshold
```{r}
GS <- ifelse(CGS < t1,0,CGS) #t1 wir oben im Histogram definiert
plot_spinach(z = GS, pal = "Grays",main="Ground Shadow (GS)")

# GS <- ifelse(CGS > t2,1,0) #t1 wir oben im Histogram definiert
# plot_spinach(z = GS, pal = "Grays",main="Ground Shadow (GS)")
```



##Step g: Ground shadow removal by subtraction
```{r}
#shadow_removed <- ifelse(ExG_Otsu==0,ExG_Otsu - GS,ExG_Otsu) #original
#shadow_removed <- ifelse(ExG_Otsu==0,ExG_Otsu +100* GS,255)
#(wenn Hintergrund (schwarz), dann Hintergrund - Pflanzenschatten, sonst weiß)
shadow_removed <- ExG - GS

plot_spinach(z = ExG, pal = "Grays",main="ExG")
plot_spinach(z = GS, pal = "Grays",main="GS")
plot_spinach(z = shadow_removed, pal = "Grays",main="Shadow removed")
plot_spinach(z = ExG_Otsu, pal = "Grays",main="ExG_Otsu")
```

Bedeckungsgrad berechnen:
```{r}
Schatten_table <- table(shadow_removed)
#0 == Boden
#100 == Pflanzen-Schatten
#255 == Pflanze (Licht)

probs <- prop.table(Schatten_table) *100 
cat("Bedeckungsgrad: ", round(probs[[2]]+probs[[3]],2), "%",
    "\nPflanze im Licht:", round(probs[[3]],2), "%", 
    "\nPflanze im Schatten: ", round(probs[[2]],2), "%", sep = "")

```
length(which(ExG_Otsu==1))/length(ExG_Otsu)*100

##save shadow-plant-image
```{r, message=FALSE}
#writeJPEG(image = z8, target = "Schatten.jpeg")

jpeg(filename = "Spinatbild2.jpeg", width = imgDm[2], height = imgDm[1])
par(mar=c(0,0,0,0))
plot_spinach(z = shadow_removed, pal = "Berlin",axes=FALSE, ylab="",xlab="")
dev.off()
```

##save Ground-shadow image
```{r}
#writeJPEG(image = z8, target = "Schatten.jpeg")

jpeg(filename = "Spinatbild1a.jpeg", width = imgDm[2], height = imgDm[1])
par(mar=c(0,0,0,0))
plot_spinach(z = GS, pal = "Grays",axes=FALSE, ylab="",xlab="")
dev.off()
```
